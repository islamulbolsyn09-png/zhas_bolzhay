<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–∞–º –∂–∞—Å—ã–Ω –∞–Ω—ã“õ—Ç–∞—É</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0"></script>
</head>
<body class="bg-gray-100 font-sans">

<header class="bg-blue-800 text-white p-6">
  <h1 class="text-3xl font-bold">üì∑ –ê–¥–∞–º –∂–∞—Å—ã–Ω –∞–Ω—ã“õ—Ç–∞—É</h1>
  <p class="mt-2">–§–æ—Ç–æ –∂“Ø–∫—Ç–µ—É –Ω–µ–º–µ—Å–µ –≤–µ–±-–∫–∞–º–µ—Ä–∞ –∞—Ä“õ—ã–ª—ã –∂–∞—Å –±–æ–ª–∂–∞—É</p>
</header>

<main class="p-6">
  <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-6">

    <!-- –°–æ–ª –∂–∞“õ: –§–æ—Ç–æ –∂“Ø–∫—Ç–µ—É + –í–µ–±-–∫–∞–º–µ—Ä–∞ -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">üñºÔ∏è –§–æ—Ç–æ –∂“Ø–∫—Ç–µ—É</h2>
      
      <input type="file" id="imageLoader" accept="image/*" class="hidden">
      <button onclick="document.getElementById('imageLoader').click()" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded mb-4 transition">
        üìÅ –§–æ—Ç–æ –∂“Ø–∫—Ç–µ—É
      </button>

      <h2 class="text-xl font-semibold mt-6 mb-4">üìπ –í–µ–±-–∫–∞–º–µ—Ä–∞–Ω—ã “õ–æ—Å—É</h2>
      <button onclick="startWebcam()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded mb-4 transition">
        üé• –í–µ–±-–∫–∞–º–µ—Ä–∞–Ω—ã “õ–æ—Å—É
      </button>

      <!-- –ë–æ–ª–∂–∞—É –±–∞—Ç—ã—Ä–º–∞—Å—ã -->
      <button id="predictBtn" onclick="predictCurrent()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded mb-4 transition" disabled>
        üîç –ë–æ–ª–∂–∞—É
      </button>

      <div id="loading" class="text-yellow-500 text-center py-4 hidden">
        –ú–æ–¥–µ–ª—å –∂“Ø–∫—Ç–µ–ª—É–¥–µ...
      </div>

      <div id="result" class="text-2xl font-bold text-center py-4 bg-gray-50 rounded">
        –ú–æ–¥–µ–ª—å –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ
      </div>

      <img id="preview" alt="Preview" class="mt-4 w-full max-w-md mx-auto rounded hidden">
      <video id="webcam" autoplay playsinline class="mt-4 w-full max-w-md mx-auto rounded hidden"></video>
    </div>

    <!-- –û“£ –∂–∞“õ: –ù”ô—Ç–∏–∂–µ -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">üìä –ù”ô—Ç–∏–∂–µ</h2>
      <div id="finalResult" class="text-3xl font-bold text-center py-8 bg-blue-50 rounded">
        –ñ–∞—Å: ...
      </div>
      <p class="text-sm text-gray-500 mt-4">* –ï–≥–µ—Ä —Ñ–æ—Ç–æ –Ω–µ–º–µ—Å–µ –∫–∞–º–µ—Ä–∞ –∞—Ä“õ—ã–ª—ã –±–æ–ª–∂–∞—É –∂–∞—Å–∞–ª—Å–∞, –Ω”ô—Ç–∏–∂–µ –æ—Å—ã –∂–µ—Ä–¥–µ –∫”©—Ä—Å–µ—Ç—ñ–ª–µ–¥—ñ.</p>
    </div>

  </div>
</main>

<footer class="bg-blue-800 text-white p-4 mt-6 text-center">
  ¬© 2025 –ê–¥–∞–º –∂–∞—Å—ã–Ω –∞–Ω—ã“õ—Ç–∞—É
</footer>

<script>
  let model;
  let currentImage = null;

  async function loadModel() {
    document.getElementById('loading').classList.remove('hidden');
    try {
      // –ú–û–î–ï–õ–¨–î–Ü“¢ –î“∞–†–´–° –ñ–û–õ–´–ù –¢–ï–ö–°–ï–†–Ü“¢–Ü–ó!
      model = await tf.loadLayersModel('./model/model.json');
      console.log('‚úÖ –ú–æ–¥–µ–ª—å –∂“Ø–∫—Ç–µ–ª–¥—ñ!');
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('result').innerText = '–ú–æ–¥–µ–ª—å –¥–∞–π—ã–Ω!';
      document.getElementById('predictBtn').disabled = false;
    } catch (error) {
      console.error('‚ùå –ú–æ–¥–µ–ª—å –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ:', error);
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('result').innerText = '–ú–æ–¥–µ–ª—å –∂“Ø–∫—Ç–µ–ª–º–µ–¥—ñ';
    }
  }

  async function predictAge(imageElement) {
    const canvas = document.createElement('canvas');
    canvas.width = 224;
    canvas.height = 224;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(imageElement, 0, 0, 224, 224);

    // –¢–µ–Ω–∑–æ—Ä“ì–∞ –∞–π–Ω–∞–ª–¥—ã—Ä—É
    let tensor = tf.browser.fromPixels(canvas)
      .resizeNearestNeighbor([224, 224])
      .toFloat()
      .div(255.0)
      .expandDims();

    // –ë–æ–ª–∂–∞—É
    const prediction = model.predict(tensor);
    const age = prediction.dataSync()[0];
    document.getElementById('finalResult').innerText = `üßç‚Äç‚ôÇÔ∏è –ñ–∞—Å: ${Math.round(age)}`;
    
    tensor.dispose();
  }

  // –§–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ—É
  document.getElementById('imageLoader').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      document.getElementById('preview').src = url;
      document.getElementById('preview').classList.remove('hidden');
      document.getElementById('webcam').classList.add('hidden');
      currentImage = img;
    };
    img.src = url;
  });

  // –í–µ–±-–∫–∞–º–µ—Ä–∞–Ω—ã “õ–æ—Å—É
  async function startWebcam() {
    const video = document.getElementById('webcam');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.classList.remove('hidden');
      document.getElementById('preview').classList.add('hidden');
      currentImage = video;
    } catch (err) {
      console.error('–ö–∞–º–µ—Ä–∞ “õ–æ—Å—ã–ª–º–∞–¥—ã:', err);
      document.getElementById('result').innerText = '–ö–∞–º–µ—Ä–∞ “õ–æ—Å—ã–ª–º–∞–¥—ã';
    }
  }

  // –ë–æ–ª–∂–∞—É –±–∞—Ç—ã—Ä–º–∞—Å—ã
  function predictCurrent() {
    if (!currentImage) {
      alert("üí° –ê–ª–¥—ã–º–µ–Ω —Ñ–æ—Ç–æ –∂“Ø–∫—Ç–µ“£—ñ–∑ –Ω–µ–º–µ—Å–µ –≤–µ–±-–∫–∞–º–µ—Ä–∞–Ω—ã “õ–æ—Å—ã“£—ã–∑!");
      return;
    }
    predictAge(currentImage);
  }

  // –ë–∞—Å—Ç–∞—É
  window.onload = loadModel;
</script>

</body>
</html>